## 简介
**ISegment** 是新一代的命令补全引擎。

ISegment具有以下功能：
- 输入一段字符串，将其解析为一段连续的参数块（Segment），所有参数块构成一个命令。
- 能够检测参数块的完整性与合法性，并在需要的情况下给出判断为不合法的原因。
- 给出参数块可选的提示（description）和补全选项。

相比于上一代命令补全引擎IntelliSense，ISegment具有的优点是：
- 易于编写复杂模式匹配代码
- 支持JSON组件与更强大的选择器参数的智能补全
- 连续输入/删除字符时更新将占用更少时间

## 设计思路

命令助手是一款有中文提示的命令辅助输入脚本，后被改为APP。
它最初使用IntelliSense作为引擎提供补全数据，但随着命令的增多，引擎本身的弊端也逐渐暴露，如：
- 匹配速度慢，较长的命令甚至需要100ms以上
- 不支持方块/物品特殊值补全
- 代码复杂，难以维护

因此便有了ISegment。

ISegment最大的特点就是在连续输入/删除的环境下可以快速工作。为此，ISegment使用了“**片段函数**”。

ISegment在识别字符串时会将字符串解析为一个或多个片段（Segment）。**片段函数是用于解析片段的函数**。每个片段拥有长度与智能补全数据（参见“智能补全数据”一节）。每个片段均对应匹配文本的一部分序列。

片段分为普通片段，横向片段和纵向片段三种类型，其中横向片段与纵向片段可以拥有子片段：横向片段的子片段叫做**块**，纵向片段的子片段叫做**层**。

普通片段的片段函数在解析文本时，需要传入上次的返回对象与需要匹配的文本，因此可以只解析更改的部分，从而节省了时间。函数会返回一个对象，该对象包含片段的长度等数据。

横向片段在解析文本时会尝试将文本分割成一个或多个不重叠的连续片段。通常片段类型的顺序是相同的。*注意：分割的过程并不是一开始进行的，而是在调用子片段函数的过程中逐渐进行的。*解析文本时，函数会首先调用第一个子片段函数，从而获得第一个块的长度与第二个块的起始位置（也就是长度的值），以此类推。解析出现错误时将会中断解析并返回错误。

纵向片段在解析文本时会尝试将文本用多个片段函数进行解析，并将返回的智能补全数据合并。该片段的长度为最长层的长度。通常来说，解析出错时会忽略出错的层，但如果所有层都解析出错则将会返会错误位置位于最靠右侧的错误。

## 片段函数

片段函数用于解析片段。

- 该函数必须接收以下参数：

|序号|参数名|类型|用途|
|---|---|---|---|
|1|tag|Object|上次调用该函数返回的结果|
|2|s|String|待匹配字符串|

- 该函数必须返回一个 `Object` 。该对象必须包含以下成员：

|序号|参数名|类型|用途|
|---|---|---|---|
|1|length|Number|字符串匹配部分的长度|
|2|canFinish|Boolean|是否该匹配部分可结束|
|3|sense|Object|智能补全的相关数据|

注：“该匹配部分可结束”指可以在匹配部分后方加入其他片段。

## 基本方法

ISegment需要定义2个基本方法： `proc` 与 `apply` 。

### proc(s : String);
该过程将对该字符串进行片段化处理。

必须步骤：
```
上次返回值 = 根片段(上次返回值, s);
```

### apply(pos : Number);
该过程将在上次返回值中寻找pos位置对应的智能补全数据并应用。

必须步骤：
```
应用智能补全数据(查找智能补全数据(pos));
```

## 智能补全数据

智能补全数据（sense）用于包含了提示与补全选项，在发生错误时会给出错误原因。

智能补全数据可以包含以下内容：

|序号|参数名|类型|用途|
|---|---|---|---|
|1|tag|RawJson|标示该段匹配内容的标签，通常需着色|
|2|prompt|RawJson|描述该片段的内容或作用|
|3|error|不限，可为空|保存解析时出现的错误|
|4|value|Array<RawJson/Function>|补全选项列表的选项数组|
|5|key|Array<RawJson>|补全选项列表的提示文字数组|
|6|callback|Function|在获取智能补全数据时调用的函数，通常用于动态生成智能补全数据|
|7|tag_prefix|RawJson|标签的前缀，仅父片段可用|
|8|tag_suffix|RawJson|标签的后缀，仅父片段可用|
|9|tag_splitter|RawJson|子标签之间的间隔文字，仅SequenceSegment可用|

智能补全数据不必包含其中的所有成员，它甚至可以为空对象。

RawJSON将在第-节讲述。

例如，对于以下命令：
```
/tp @a @s
```
IntelliSense会显示如下：
```
/tp <目标实体> <目的地实体:实体>
将目标实体传送至目的地实体
[...] - 插入参数
```
第一行为tag，父片段的tag通常由子片段组合而成。  
第二行为prompt，通常会显示较深层片段的提示。  
第三行及之后为提示列表，即key数组、value数组组成的键值对。

