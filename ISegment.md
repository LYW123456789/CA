## 1. 简介
**ISegment** 是新一代的命令补全引擎。

ISegment具有以下功能：
- 输入一段字符串，将其解析为一段连续的参数块（Segment），所有参数块构成一个命令。
- 能够检测参数块的完整性与合法性，并在需要的情况下给出判断为不合法的原因。
- 给出参数块可选的提示（description）和补全选项。

相比于上一代命令补全引擎IntelliSense，ISegment具有的优点是：
- 易于编写复杂模式匹配代码
- 支持JSON组件与更强大的选择器参数的智能补全
- 连续输入/删除字符时更新将占用更少时间

ISegment在识别字符串时会将字符串分割为一个或多个参数块（Segment），且每个参数块都可以被分为更小的参数块。例如：
```
/tp @p 12 ~6 12
```
会被分解为4个Segment： `/` 、`tp` 、空格 、 `@p 12 ~6 12` 。
> 其中最后一个Segment又可分为3个Segment： `@p` 、 空格 和 `12 ~6 12` 。

正因如此，在匹配字符串的时候，ISegment只会处理编辑位后方的Segment，并返回相关数据。例如：
```
/setblock 5 9 7 grass
```
如果在 `grass` 处编辑则只会处理 `grass` 部分的匹配。如果在 `setblock` 处编辑则处理 `setblock 5 9 7 grass` 的匹配。

## 2. 片段格式

ISegment的片段必须为一个函数。

- 该函数必须接收以下参数：
|序号|参数名|类型|用途|
|---|---|---|---|
|1|tag|Object|上次调用该函数返回的结果|
|2|s|String|待匹配字符串|

- 该函数必须返回一个 `Object` 。该对象必须包含以下成员：
|序号|参数名|类型|用途|
|---|---|---|---|
|1|length|Number|字符串匹配部分的长度|
|2|canFinish|Boolean|是否该匹配部分可结束|
|3|sense|Object|智能补全的相关数据|
注：“该匹配部分可结束”指可以在匹配部分后方加入其他片段。

## 3. 基本方法

ISegment需要定义2个基本方法： `proc` 与 `apply` 。

### proc(s : String);
该过程将对该字符串进行片段化处理。

必须步骤：
```
上次返回值 = 根片段(上次返回值, s);
```

### apply(pos : Number);
该过程将在上次返回值中寻找pos位置对应的智能补全数据并应用。

必须步骤：
```
应用智能补全数据(查找智能补全数据(pos));
```

## 4. 智能补全数据

智能补全数据（sense）用于包含了提示与补全选项，在发生错误时会给出错误原因。

智能补全数据可以包含以下内容：
|序号|参数名|类型|用途|
|---|---|---|---|
|1|tag|RawJson|标示该段匹配内容的标签，通常需着色|
|2|prompt|RawJson|描述该片段的内容或作用|
|3|error|不限，可为空|保存解析时出现的错误|
|4|value|Array<RawJson/Function>|补全选项列表的选项数组|
|5|key|Array<RawJson>|补全选项列表的提示文字数组|
|6|callback|Function|在获取智能补全数据时调用的函数，通常用于动态生成智能补全数据|
智能补全数据不必包含其中的所有成员，它甚至可以为空对象。 
RawJSON将在第-节讲述。

例如，对于以下命令：
```
/tp @a @s
```
IntelliSense会显示如下：
```
/tp <目标实体> <目的地实体:实体>
将目标实体传送至目的地实体
[...] - 插入参数
```
第一行为tag，父片段的tag通常由子片段组合而成。  
第二行为prompt，通常会显示较深层片段的提示。  
第三行及之后为提示列表，即key数组、value数组组成的键值对。

